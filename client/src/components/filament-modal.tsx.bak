import { useState, useEffect } from "react";
import { Filament, InsertFilament, insertFilamentSchema } from "@shared/schema";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { format } from "date-fns";
import { de } from "date-fns/locale";
import { CalendarIcon, Scan, ScanFace, Copy } from "lucide-react";
import { cn } from "@/lib/utils";
import { useQuery } from "@tanstack/react-query";
import { apiRequest } from "@/lib/queryClient";

// Liste der Bambulab Materialtypen
const MATERIAL_TYPES = [
  { value: "PLA", label: "PLA" },
  { value: "PETG", label: "PETG" },
  { value: "ABS", label: "ABS" },
  { value: "TPU", label: "TPU" },
  { value: "ASA", label: "ASA" },
  { value: "PA", label: "PA (Nylon)" },
  { value: "PC", label: "PC (Polycarbonat)" },
  { value: "PVA", label: "PVA" },
  { value: "HIPS", label: "HIPS" },
  { value: "PLA-CF", label: "PLA-CF (Karbon)" },
  { value: "PA-CF", label: "PA-CF (Nylon Karbon)" },
  { value: "PETG-CF", label: "PETG-CF (Karbon)" },
  { value: "PET-CF", label: "PET-CF (Karbon)" },
  { value: "PLA-HF", label: "PLA-HF (HighFlow)" },
  { value: "PP", label: "PP (Polypropylen)" },
  { value: "PETG-HF", label: "PETG-HF (HighFlow)" },
  { value: "PPS", label: "PPS" },
  { value: "PEEK", label: "PEEK" },
  { value: "PEI", label: "PEI/ULTEM" },
  { value: "OTHER", label: "Anderes" }
];

// Liste bekannter Filament-Hersteller
const MANUFACTURERS = [
  "Bambu Lab",
  "Prusament",
  "Polymaker",
  "Overture",
  "Sunlu",
  "eSun",
  "Eryone",
  "3DJake",
  "3DJAKE",
  "Filamentum",
  "Filament PM",
  "Fiberlogy",
  "FormFutura",
  "Verbatim",
  "ColorFabb",
  "BASF",
  "Fillamentum",
  "Das Filament",
  "Extrudr",
  "3D Warhorse",
  "3D-Fuel",
  "3DXTECH",
  "AddNorth",
  "Spectrum",
  "Ultimaker",
  "Creality",
  "Inland",
  "Hatchbox",
  "MatterHackers",
  "GEEETECH",
  "Amolen",
  "Raise3D",
  "Sovol",
  "Dremel",
  "Elegoo",
  "TECHNOLOGYOUTLET",
  "FlashForge",
  "1.75mm Shop",
  "3DPrima",
  "3DLAC",
  "ZYYX"
];

// Bambulab Farben
const BAMBULAB_COLORS = [
  // Standard Farben
  { name: "Schwarz", code: "#000000" },
  { name: "Weiß", code: "#FFFFFF" },
  { name: "Grau", code: "#808080" },
  { name: "Dunkelgrau", code: "#444444" },
  { name: "Hellgrau", code: "#D3D3D3" },
  { name: "Silber", code: "#C0C0C0" },
  { name: "Rot", code: "#FF0000" },
  { name: "Hellrot", code: "#FF5252" },
  { name: "Dunkelrot", code: "#8B0000" },
  { name: "Blau", code: "#0000FF" },
  { name: "Hellblau", code: "#ADD8E6" },
  { name: "Dunkelblau", code: "#00008B" },
  { name: "Grün", code: "#00FF00" },
  { name: "Hellgrün", code: "#90EE90" },
  { name: "Dunkelgrün", code: "#006400" },
  { name: "Gelb", code: "#FFFF00" },
  { name: "Orange", code: "#FFA500" },
  { name: "Lila", code: "#800080" },
  { name: "Rosa", code: "#FFC0CB" },
  { name: "Braun", code: "#A52A2A" },
  
  // Spezielle Finishes
  { name: "Gold", code: "#FFD700" },
  { name: "Kupfer", code: "#B87333" },
  { name: "Transparent", code: "#FFFFFF", opacity: 0.3 },
  { name: "Glitzer Silber", code: "#E0E0E0" },
  { name: "Glitzer Gold", code: "#FFD700" },
  { name: "Glitzer Blau", code: "#4169E1" },
  { name: "Perlmutt", code: "#EAEAEA" },
  { name: "Neon Gelb", code: "#FFFF00" },
  { name: "Neon Grün", code: "#39FF14" },
  { name: "Neon Rosa", code: "#FF69B4" },
  { name: "Nachtleuchtend", code: "#CCFFCC" },
  
  // Wood Serie
  { name: "Wood - Birke", code: "#F5DEB3" },
  { name: "Wood - Eiche", code: "#DEB887" },
  { name: "Wood - Ahorn", code: "#EADDCA" },
  { name: "Wood - Kirsche", code: "#954535" },
  { name: "Wood - Wallnuss", code: "#614126" },
  { name: "Wood - Ebenholz", code: "#3D2B1F" },
  
  // Cool/Marble Serie
  { name: "Marmor", code: "#F5F5F5" },
  { name: "Galaxy", code: "#191970" },
  { name: "Farbwechselnd Blau-Grün", code: "#1E90FF" },
  { name: "Farbwechselnd Rot-Gelb", code: "#FF4500" }
];

// Drucktemperaturen nach Materialtyp
const PRINT_TEMPERATURES: Record<string, string> = {
  "PLA": "190-220°C",
  "PLA-CF": "200-230°C",
  "PLA-HF": "200-230°C",
  "PETG": "230-250°C",
  "PETG-CF": "240-260°C",
  "PETG-HF": "240-260°C",
  "ABS": "230-250°C",
  "TPU": "220-240°C",
  "ASA": "240-260°C",
  "PA": "250-270°C",
  "PA-CF": "260-280°C",
  "PC": "250-280°C",
  "PVA": "190-210°C",
  "HIPS": "230-250°C",
  "PP": "220-240°C",
  "PPS": "260-290°C",
  "PEEK": "360-400°C",
  "PET-CF": "240-260°C",
  "PEI": "350-380°C",
  "OTHER": ""
};
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Slider } from "@/components/ui/slider";
import { Calendar } from "@/components/ui/calendar";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { QRScanner } from "./qr-scanner";
import { NFCScanner } from "./nfc-scanner";

// Erstellen Sie ein eigenes Schema für das Formular
const formSchema = z.object({
  name: z.string().min(1, "Name ist erforderlich"),
  manufacturer: z.string().optional(),
  material: z.string().min(1, "Material ist erforderlich"),
  colorName: z.string().min(1, "Farbe ist erforderlich"),
  colorCode: z.string().optional(),
  diameter: z.number().optional(),
  printTemp: z.string().optional(),
  totalWeight: z.number().min(0.1, "Gesamtgewicht muss mindestens 0.1kg sein"),
  remainingPercentage: z.number().min(0).max(100),
  purchaseDate: z.date().optional(),
  purchasePrice: z.number().min(0).optional(),
  status: z.enum(["sealed", "opened"]),
  spoolType: z.enum(["spooled", "spoolless"]),
  dryerCount: z.number().min(0).default(0),
  lastDryingDate: z.date().optional(),
  storageLocation: z.string().optional(),
});

type FormValues = z.infer<typeof formSchema>;

interface FilamentModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: (filament: FormValues) => void;
  filament?: Filament;
}

// Interfaces für Daten aus der Datenbank
interface Manufacturer {
  id: number;
  name: string;
  createdAt: string;
}

interface Color {
  id: number;
  name: string;
  code: string;
  createdAt: string;
}

interface Material {
  id: number;
  name: string;
  createdAt: string;
}

export function FilamentModal({
  isOpen,
  onClose,
  onSave,
  filament,
}: FilamentModalProps) {
  const isEditing = !!filament;
  const [remainingPercentage, setRemainingPercentage] = useState(100);
  const [totalWeight, setTotalWeight] = useState<number | string>(1);
  const [customWeightVisible, setCustomWeightVisible] = useState(false);
  const [showQRScanner, setShowQRScanner] = useState(false);
  const [showNFCScanner, setShowNFCScanner] = useState(false);
  
  // Daten aus der Datenbank laden
  const { data: manufacturers = [] } = useQuery({
    queryKey: ['/api/manufacturers'],
    queryFn: () => apiRequest<Manufacturer[]>('/api/manufacturers'),
    enabled: isOpen
  });
  
  const { data: colors = [] } = useQuery({
    queryKey: ['/api/colors'],
    queryFn: () => apiRequest<Color[]>('/api/colors'),
    enabled: isOpen
  });
  
  const { data: materials = [] } = useQuery({
    queryKey: ['/api/materials'],
    queryFn: () => apiRequest<Material[]>('/api/materials'),
    enabled: isOpen
  });
  
  const { data: diameters = [] } = useQuery({
    queryKey: ['/api/diameters'],
    queryFn: () => apiRequest<{id: number, value: string}[]>('/api/diameters'),
    enabled: isOpen
  });
  
  // Lagerorte aus der Datenbank
  const { data: storageLocationData = [] } = useQuery({
    queryKey: ['/api/storage-locations'],
    queryFn: () => apiRequest<{id: number, name: string}[]>('/api/storage-locations'),
    enabled: isOpen
  });
  
  // Extrahiere Namen der Lagerorte
  const storageLocations = storageLocationData.map(loc => loc.name);

  // Setup form with default values or editing values
  const form = useForm<FormValues>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      name: filament?.name || "",
      manufacturer: filament?.manufacturer || "",
      material: filament?.material || "",
      colorName: filament?.colorName || "",
      colorCode: filament?.colorCode || "#000000",
      diameter: filament?.diameter ? Number(filament.diameter) : 1.75,
      printTemp: filament?.printTemp || "",
      totalWeight: filament?.totalWeight ? Number(filament.totalWeight) : 1,
      remainingPercentage: filament?.remainingPercentage ? Number(filament.remainingPercentage) : 100,
      purchaseDate: filament?.purchaseDate ? new Date(filament.purchaseDate) : undefined,
      purchasePrice: filament?.purchasePrice ? Number(filament.purchasePrice) : undefined,
      status: (filament?.status as any) || undefined,
      spoolType: (filament?.spoolType as any) || undefined,
      dryerCount: filament?.dryerCount || 0,
      lastDryingDate: filament?.lastDryingDate ? new Date(filament.lastDryingDate) : undefined,
      storageLocation: filament?.storageLocation || ""
    },
  });

  // Update form when filament changes
  useEffect(() => {
    if (filament) {
      form.reset({
        name: filament.name,
        manufacturer: filament.manufacturer || "",
        material: filament.material,
        colorName: filament.colorName,
        colorCode: filament.colorCode || "#000000",
        diameter: Number(filament.diameter),
        printTemp: filament.printTemp || "",
        totalWeight: Number(filament.totalWeight),
        remainingPercentage: Number(filament.remainingPercentage),
        purchaseDate: filament.purchaseDate ? new Date(filament.purchaseDate) : undefined,
        purchasePrice: filament.purchasePrice ? Number(filament.purchasePrice) : undefined,
        status: (filament.status as any) || undefined,
        spoolType: (filament.spoolType as any) || undefined,
        dryerCount: filament.dryerCount || 0,
        lastDryingDate: filament.lastDryingDate ? new Date(filament.lastDryingDate) : undefined,
        storageLocation: filament.storageLocation || ""
      });
      
      setRemainingPercentage(Number(filament.remainingPercentage));
      setTotalWeight(Number(filament.totalWeight));
      
      // Check if we need to show custom weight field
      if (![0.25, 0.5, 0.75, 1, 1.5, 2, 2.5, 3, 5].includes(Number(filament.totalWeight))) {
        setCustomWeightVisible(true);
      }
    } else {
      form.reset({
        name: "",
        manufacturer: "",
        material: "",
        colorName: "",
        colorCode: "#000000",
        diameter: 1.75,
        printTemp: "",
        totalWeight: 1,
        remainingPercentage: 100,
        purchaseDate: undefined,
        purchasePrice: undefined,
        status: undefined,
        spoolType: undefined,
        dryerCount: 0,
        lastDryingDate: undefined,
        storageLocation: ""
      });
      setRemainingPercentage(100);
      setTotalWeight(1);
      setCustomWeightVisible(false);
    }
  }, [filament, form]);

  // Handle form submission
  const onSubmit = (data: FormValues) => {
    // Handle custom weight
    if (customWeightVisible && typeof totalWeight === 'number') {
      data.totalWeight = totalWeight;
    }
    
    onSave(data);
  };

  // Helper to calculate remaining weight
  const calculateRemainingWeight = () => {
    const total = typeof totalWeight === 'number' ? totalWeight : parseFloat(String(totalWeight)) || 0;
    return ((total * remainingPercentage) / 100).toFixed(2);
  };

  // Handle total weight selection
  const handleTotalWeightChange = (value: string) => {
    if (value === 'custom') {
      setCustomWeightVisible(true);
      // Keep existing value if already in custom mode
      return;
    }
    
    setCustomWeightVisible(false);
    const numericValue = parseFloat(value);
    setTotalWeight(numericValue);
    form.setValue('totalWeight', numericValue);
  };

  // Handle custom weight input
  const handleCustomWeightChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = parseFloat(e.target.value);
    if (!isNaN(value)) {
      setTotalWeight(value);
      form.setValue('totalWeight', value);
    }
  };

  // Handler für QR-Code Scan
  const handleQRCodeScanned = (decodedText: string) => {
    setShowQRScanner(false);
    try {
      // Versuche, den gescannten Text als JSON zu parsen
      const data = JSON.parse(decodedText);
      
      // Überprüfe, ob es sich um Filament-Daten handelt
      if (data.name && data.material) {
        // Setze die Formularwerte basierend auf den gescannten Daten
        form.setValue('name', data.name);
        if (data.manufacturer) form.setValue('manufacturer', data.manufacturer);
        if (data.material) form.setValue('material', data.material);
        if (data.colorName) form.setValue('colorName', data.colorName);
        if (data.colorCode) form.setValue('colorCode', data.colorCode);
        if (data.diameter) form.setValue('diameter', Number(data.diameter));
        if (data.printTemp) form.setValue('printTemp', data.printTemp);
        if (data.totalWeight) {
          const weight = Number(data.totalWeight);
          setTotalWeight(weight);
          form.setValue('totalWeight', weight);
          
          // Check if we need to show custom weight field
          if (![0.25, 0.5, 0.75, 1, 1.5, 2, 2.5, 3, 5].includes(weight)) {
            setCustomWeightVisible(true);
          } else {
            setCustomWeightVisible(false);
          }
        }
      }
    } catch (error) {
      console.error('Fehler beim Verarbeiten des QR-Codes:', error);
      // Hier könnte man eine Fehlermeldung anzeigen
    }
  };
  
  // Handler für NFC Scan
  const handleNFCScanned = (data: any) => {
    setShowNFCScanner(false);
    
    try {
      // Extrahiere Textdaten aus NFC-Records
      const textRecords = data.records.filter((record: any) => record.type === 'text');
      
      if (textRecords.length > 0) {
        // Versuche, den Text als JSON zu parsen
        const jsonData = JSON.parse(textRecords[0].text);
        
        if (jsonData.name && jsonData.material) {
          // Setze die Formularwerte basierend auf den gescannten Daten
          form.setValue('name', jsonData.name);
          if (jsonData.manufacturer) form.setValue('manufacturer', jsonData.manufacturer);
          if (jsonData.material) form.setValue('material', jsonData.material);
          if (jsonData.colorName) form.setValue('colorName', jsonData.colorName);
          if (jsonData.colorCode) form.setValue('colorCode', jsonData.colorCode);
          if (jsonData.diameter) form.setValue('diameter', Number(jsonData.diameter));
          if (jsonData.printTemp) form.setValue('printTemp', jsonData.printTemp);
          if (jsonData.totalWeight) {
            const weight = Number(jsonData.totalWeight);
            setTotalWeight(weight);
            form.setValue('totalWeight', weight);
            
            // Check if we need to show custom weight field
            if (![0.25, 0.5, 0.75, 1, 1.5, 2, 2.5, 3, 5].includes(weight)) {
              setCustomWeightVisible(true);
            } else {
              setCustomWeightVisible(false);
            }
          }
        }
      }
    } catch (error) {
      console.error('Fehler beim Verarbeiten des NFC-Tags:', error);
      // Hier könnte man eine Fehlermeldung anzeigen
    }
  };

  return (
    <>
      {showQRScanner && (
        <QRScanner 
          onScanSuccess={handleQRCodeScanned} 
          onClose={() => setShowQRScanner(false)}
        />
      )}
      
      {showNFCScanner && (
        <NFCScanner 
          onScanSuccess={handleNFCScanned} 
          onClose={() => setShowNFCScanner(false)}
        />
      )}
    
      <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>
        <DialogContent className="sm:max-w-md max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>{isEditing ? "Filament bearbeiten" : "Filament hinzufügen"}</DialogTitle>
          </DialogHeader>
          
          <Form {...form}>
            <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
              <div className="flex gap-2 mb-4 justify-end">
                <Button 
                  type="button" 
                  variant="outline" 
                  size="sm"
                  onClick={() => setShowQRScanner(true)}
                  className="flex items-center"
                >
                  <Scan className="mr-2 h-4 w-4" />
                  QR-Code scannen
                </Button>
                <Button 
                  type="button" 
                  variant="outline" 
                  size="sm"
                  onClick={() => setShowNFCScanner(true)}
                  className="flex items-center"
                >
                  <ScanFace className="mr-2 h-4 w-4" />
                  NFC scannen
                </Button>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <FormField
                  control={form.control}
                  name="name"
                  render={({ field }) => (
                    <FormItem className="col-span-2">
                      <FormLabel>Name*</FormLabel>
                      <FormControl>
                        <Input
                          placeholder="z.B. PLA Schwarz Bambu Lab"
                          {...field}
                        />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                
                <FormField
                  control={form.control}
                  name="manufacturer"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Hersteller</FormLabel>
                      <Select
                        onValueChange={field.onChange}
                        value={typeof field.value === 'string' ? field.value : ''}
                      >
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Hersteller wählen oder eingeben" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          <div className="relative">
                            <Input
                              className="mb-2 sticky top-0 z-10"
                              placeholder="Hersteller suchen oder eingeben..."
                              onChange={(e) => {
                                if (e.target.value && !manufacturers.find(m => m.name === e.target.value)) {
                                  field.onChange(e.target.value);
                                }
                              }}
                              onKeyDown={(e) => {
                                if (e.key === "Enter") {
                                  e.preventDefault();
                                  const value = (e.target as HTMLInputElement).value;
                                  if (value) {
                                    field.onChange(value);
                                  }
                                }
                              }}
                            />
                          </div>
                          {manufacturers.map((manufacturer) => (
                            <SelectItem 
                              key={manufacturer.id} 
                              value={manufacturer.name}
                            >
                              {manufacturer.name}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                
                <FormField
                  control={form.control}
                  name="material"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Material*</FormLabel>
                      <Select
                        onValueChange={(value) => {
                          field.onChange(value);
                          // Automatisch Drucktemperatur einstellen
                          if (value in PRINT_TEMPERATURES) {
                            form.setValue('printTemp', PRINT_TEMPERATURES[value as keyof typeof PRINT_TEMPERATURES]);
                          }
                          // Automatisch Namen aktualisieren, wenn Material und Farbe vorhanden
                          const colorName = form.getValues('colorName');
                          const manufacturer = form.getValues('manufacturer');
                          if (colorName && value) {
                            const mfgText = manufacturer ? ` ${manufacturer}` : '';
                            form.setValue('name', `${value} ${colorName}${mfgText}`);
                          }
                        }}
                        defaultValue={field.value}
                        value={field.value}
                      >
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Bitte auswählen" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          <div className="relative">
                            <Input
                              className="mb-2 sticky top-0 z-10"
                              placeholder="Material suchen..."
                              onChange={(e) => {
                                if (e.target.value && !materials.find(m => m.name === e.target.value)) {
                                  field.onChange(e.target.value);
                                }
                              }}
                              onKeyDown={(e) => {
                                if (e.key === "Enter") {
                                  e.preventDefault();
                                  const value = (e.target as HTMLInputElement).value;
                                  if (value) {
                                    field.onChange(value);
                                  }
                                }
                              }}
                            />
                          </div>
                          {materials.map((material) => (
                            <SelectItem key={material.id} value={material.name}>
                              {material.name}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                
                <FormField
                  control={form.control}
                  name="colorName"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Farbe Name*</FormLabel>
                      <Select
                        onValueChange={(value) => {
                          field.onChange(value);
                          // Setze automatisch den Farbcode
                          const colorObj = colors.find(c => c.name === value);
                          if (colorObj) {
                            form.setValue('colorCode', colorObj.code);
                          }
                          // Automatisch Namen aktualisieren, wenn Material und Farbe vorhanden
                          const material = form.getValues('material');
                          const manufacturer = form.getValues('manufacturer');
                          if (material && value) {
                            const mfgText = manufacturer ? ` ${manufacturer}` : '';
                            form.setValue('name', `${material} ${value}${mfgText}`);
                          }
                        }}
                        defaultValue={field.value}
                        value={field.value}
                      >
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Farbe wählen" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          <div className="relative">
                            <Input
                              className="mb-2 sticky top-0 z-10"
                              placeholder="Farbe suchen..."
                              onChange={(e) => {
                                if (e.target.value && !colors.find(c => c.name === e.target.value)) {
                                  field.onChange(e.target.value);
                                }
                              }}
                              onKeyDown={(e) => {
                                if (e.key === "Enter") {
                                  e.preventDefault();
                                  const value = (e.target as HTMLInputElement).value;
                                  if (value) {
                                    field.onChange(value);
                                  }
                                }
                              }}
                            />
                          </div>
                          {colors.map((color) => (
                            <SelectItem key={color.id} value={color.name}>
                              <div className="flex items-center">
                                <div 
                                  className="h-4 w-4 rounded-full mr-2 border border-neutral-300" 
                                  style={{ backgroundColor: color.code }}
                                />
                                {color.name}
                              </div>
                            </SelectItem>
                          ))}
                          <SelectItem value="Benutzerdefiniert">
                            <div className="flex items-center">
                              <div className="h-4 w-4 rounded-full mr-2 border border-neutral-300 bg-gradient-to-r from-red-500 via-green-500 to-blue-500" />
                              Benutzerdefiniert
                            </div>
                          </SelectItem>
                        </SelectContent>
                      </Select>
                      {field.value === "Benutzerdefiniert" && (
                        <div className="mt-2">
                          <Input
                            placeholder="Eigene Farbbezeichnung"
                            onChange={(e) => field.onChange(e.target.value)}
                          />
                        </div>
                      )}
                      <FormMessage />
                    </FormItem>
                  )}
                />
                
                <FormField
                  control={form.control}
                  name="colorCode"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Farbe Code</FormLabel>
                      <FormControl>
                        <div className="flex">
                          <Input
                            type="color"
                            className="h-10 w-10 p-0.5 border border-neutral-200 rounded-md cursor-pointer"
                            {...field}
                          />
                          <Input
                            className="flex-grow ml-2"
                            placeholder="#000000"
                            value={field.value}
                            onChange={(e) => {
                              // Validate hex color code format
                              if (e.target.value.match(/^#[0-9A-F]{6}$/i) || e.target.value === "") {
                                field.onChange(e.target.value);
                              }
                            }}
                          />
                        </div>
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                
                <FormField
                  control={form.control}
                  name="diameter"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Durchmesser (mm)</FormLabel>
                      <Select
                        onValueChange={(value) => field.onChange(parseFloat(value))}
                        defaultValue={field.value ? field.value.toString() : "1.75"}
                        value={field.value ? field.value.toString() : "1.75"}
                      >
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Durchmesser wählen" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          {diameters.map((diameter) => (
                            <SelectItem 
                              key={diameter.id} 
                              value={diameter.value}
                            >
                              {diameter.value}mm
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                
                <FormField
                  control={form.control}
                  name="printTemp"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Druck-Temperatur (°C)</FormLabel>
                      <FormControl>
                        <Input
                          placeholder="z.B. 200-220"
                          {...field}
                        />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </div>
              
              <div className="border rounded-md p-4 bg-neutral-900">
                <h4 className="font-medium text-neutral-400 mb-3">Menge</h4>
                <div className="space-y-4">
                  <div>
                    <FormLabel>Gesamtgewicht (kg)*</FormLabel>
                    <Select
                      onValueChange={handleTotalWeightChange}
                      defaultValue={customWeightVisible ? "custom" : totalWeight.toString()}
                      value={customWeightVisible ? "custom" : totalWeight.toString()}
                    >
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Gesamtgewicht wählen" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        <SelectItem value="0.25">0.25kg</SelectItem>
                        <SelectItem value="0.5">0.5kg</SelectItem>
                        <SelectItem value="0.75">0.75kg</SelectItem>
                        <SelectItem value="1">1kg</SelectItem>
                        <SelectItem value="1.5">1.5kg</SelectItem>
                        <SelectItem value="2">2kg</SelectItem>
                        <SelectItem value="2.5">2.5kg</SelectItem>
                        <SelectItem value="3">3kg</SelectItem>
                        <SelectItem value="5">5kg</SelectItem>
                        <SelectItem value="custom">Benutzerdefiniert</SelectItem>
                      </SelectContent>
                    </Select>
                    
                    {customWeightVisible && (
                      <div className="mt-2">
                        <Input
                          type="number"
                          step="0.01"
                          min="0.1"
                          placeholder="Gewicht in kg eingeben"
                          value={typeof totalWeight === 'number' ? totalWeight : ''}
                          onChange={handleCustomWeightChange}
                        />
                      </div>
                    )}
                  </div>
                  
                  <FormField
                    control={form.control}
                    name="remainingPercentage"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Restmenge (%)*</FormLabel>
                        <div className="flex items-center">
                          <FormControl>
                            <Slider
                              value={[field.value]}
                              min={0}
                              max={100}
                              step={5}
                              onValueChange={(values) => {
                                const value = values[0];
                                field.onChange(value);
                                setRemainingPercentage(value);
                              }}
                              className="w-full mr-2"
                            />
                          </FormControl>
                          <span className="font-medium text-neutral-400 w-10 text-right">
                            {field.value}%
                          </span>
                        </div>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                  
                  <div>
                    <div className="flex justify-between text-sm mb-1">
                      <span className="text-neutral-300">Entspricht:</span>
                      <span className="font-medium text-neutral-400">
                        {calculateRemainingWeight()}kg
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div className="border rounded-md p-4 bg-neutral-900">
                <h4 className="font-medium text-neutral-400 mb-3">Zusätzliche Informationen</h4>
                <div className="grid grid-cols-2 gap-4">
                  <FormField
                    control={form.control}
                    name="purchaseDate"
                    render={({ field }) => (
                      <FormItem className="flex flex-col">
                        <FormLabel>Kaufdatum</FormLabel>
                        <Popover>
                          <PopoverTrigger asChild>
                            <FormControl>
                              <Button
                                variant={"outline"}
                                className={
                                  "w-full pl-3 text-left font-normal flex justify-between"
                                }
                              >
                                {field.value ? (
                                  format(field.value, "dd.MM.yyyy", { locale: de })
                                ) : (
                                  <span className="text-neutral-400">Datum wählen</span>
                                )}
                                <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                              </Button>
                            </FormControl>
                          </PopoverTrigger>
                          <PopoverContent className="w-auto p-0" align="start">
                            <Calendar
                              mode="single"
                              selected={field.value}
                              onSelect={field.onChange}
                              disabled={(date) =>
                                date > new Date() || date < new Date("1900-01-01")
                              }
                              locale={de}
                              initialFocus
                            />
                          </PopoverContent>
                        </Popover>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                  
                  <FormField
                    control={form.control}
                    name="purchasePrice"
                    render={({ field }) => (
                      <FormItem className="flex flex-col">
                        <FormLabel>Kaufpreis (€)</FormLabel>
                        <FormControl>
                          <Input
                            type="number"
                            step="0.01"
                            min="0"
                            placeholder="z.B. 20.99"
                            value={field.value !== undefined ? field.value : ''}
                            onChange={(e) => {
                              const value = e.target.value !== '' ? parseFloat(e.target.value) : undefined;
                              field.onChange(value);
                            }}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                  
                  <FormField
                    control={form.control}
                    name="storageLocation"
                    render={({ field }) => (
                      <FormItem className="flex flex-col">
                        <FormLabel>Lagerort</FormLabel>
                        <Select
                          onValueChange={field.onChange}
                          value={field.value || ""}
                        >
                          <FormControl>
                            <SelectTrigger>
                              <SelectValue placeholder="Lagerort auswählen oder eingeben" />
                            </SelectTrigger>
                          </FormControl>
                          <SelectContent>
                            <div className="relative">
                              <Input
                                className="mb-2 sticky top-0 z-10"
                                placeholder="Lagerort eingeben..."
                                onChange={(e) => {
                                  if (e.target.value) {
                                    field.onChange(e.target.value);
                                  }
                                }}
                                onKeyDown={(e) => {
                                  if (e.key === "Enter") {
                                    e.preventDefault();
                                    const value = (e.target as HTMLInputElement).value;
                                    if (value) {
                                      field.onChange(value);
                                    }
                                  }
                                }}
                              />
                            </div>
                            {storageLocations.map((location) => (
                              <SelectItem 
                                key={location} 
                                value={location}
                              >
                                {location}
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>
              </div>
              
              <div className="border rounded-md p-4 bg-neutral-900">
                <h4 className="font-medium text-neutral-400 mb-3">Status</h4>
                <div className="grid grid-cols-2 gap-4">
                  <FormField
                    control={form.control}
                    name="status"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Verpackung</FormLabel>
                        <Select
                          onValueChange={field.onChange}
                          value={field.value}
                        >
                          <FormControl>
                            <SelectTrigger>
                              <SelectValue placeholder="Bitte wählen..." />
                            </SelectTrigger>
                          </FormControl>
                          <SelectContent>
                            <SelectItem value="sealed">Versiegelt (noch nicht geöffnet)</SelectItem>
                            <SelectItem value="opened">Geöffnet (in Benutzung)</SelectItem>
                          </SelectContent>
                        </Select>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                  
                  <FormField
                    control={form.control}
                    name="spoolType"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Rollentyp</FormLabel>
                        <Select
                          onValueChange={field.onChange}
                          value={field.value}
                        >
                          <FormControl>
                            <SelectTrigger>
                              <SelectValue placeholder="Bitte wählen..." />
                            </SelectTrigger>
                          </FormControl>
                          <SelectContent>
                            <SelectItem value="spooled">Spule (Standard)</SelectItem>
                            <SelectItem value="spoolless">Spulenlos</SelectItem>
                          </SelectContent>
                        </Select>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>

                <h4 className="font-medium text-neutral-400 mb-3 mt-4">Trocknung</h4>
                <div className="grid grid-cols-2 gap-4">
                  <FormField
                    control={form.control}
                    name="dryerCount"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Trocknungsanzahl</FormLabel>
                        <FormControl>
                          <Input
                            type="number"
                            min="0"
                            step="1"
                            placeholder="0"
                            {...field}
                            onChange={(e) => field.onChange(e.target.valueAsNumber || 0)}
                          />
                        </FormControl>
                        <FormDescription className="text-xs">
                          Wie oft wurde dieses Filament getrocknet?
                        </FormDescription>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                  
                  <FormField
                    control={form.control}
                    name="lastDryingDate"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Letzte Trocknung</FormLabel>
                        <Popover>
                          <PopoverTrigger asChild>
                            <FormControl>
                              <Button
                                variant={"outline"}
                                className={cn(
                                  "w-full pl-3 text-left font-normal",
                                  !field.value && "text-muted-foreground"
                                )}
                              >
                                {field.value ? (
                                  format(field.value, "dd.MM.yyyy")
                                ) : (
                                  <span>Kein Datum</span>
                                )}
                                <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                              </Button>
                            </FormControl>
                          </PopoverTrigger>
                          <PopoverContent className="w-auto p-0" align="start">
                            <Calendar
                              mode="single"
                              selected={field.value}
                              onSelect={field.onChange}
                              initialFocus
                            />
                          </PopoverContent>
                        </Popover>
                        <FormDescription className="text-xs">
                          Wann wurde das Filament zuletzt getrocknet?
                        </FormDescription>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>
              </div>
              
              <DialogFooter className="pt-2 border-t border-neutral-200">
                <div className="flex items-center mr-auto space-x-2">
                  <Button
                    type="button"
                    variant="outline"
                    size="icon"
                    onClick={() => setShowQRScanner(true)}
                    title="QR-Code scannen"
                  >
                    <Scan className="h-4 w-4" />
                  </Button>
                  <Button
                    type="button"
                    variant="outline"
                    size="icon"
                    onClick={() => setShowNFCScanner(true)}
                    title="NFC scannen"
                  >
                    <ScanFace className="h-4 w-4" />
                  </Button>
                </div>
                <Button
                  type="button"
                  variant="outline"
                  onClick={onClose}
                >
                  Abbrechen
                </Button>
                <Button type="submit">
                  Speichern
                </Button>
              </DialogFooter>
            </form>
          </Form>
        </DialogContent>
      </Dialog>
    </>
  );
}